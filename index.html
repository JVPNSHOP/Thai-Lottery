<!DOCTYPE html>
<html lang="my">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>2D / 3D ရောင်းချက် • Reverse • Bulk • Voucher + Summary (Auto PDF)</title>
<style>
:root{
  --bg:#0f172a; --panel:#0b1220; --ink:#e5e7eb; --soft:#9aa4b2;
  --line:rgba(255,255,255,.10); --cyan:#22d3ee; --sky:#38bdf8;
  --red:#ef4444; --ok:#10b981;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#081022,#0f172a 60%);color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Helvetica,Arial,"Noto Sans Myanmar",sans-serif}
.wrap{max-width:1100px;margin:auto;padding:28px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:10px;flex-wrap:wrap}
h1{margin:0;font-size:20px}
.badge{background:linear-gradient(90deg,var(--cyan),var(--sky));color:#001018;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px}
.grid{display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--line);border-radius:16px;box-shadow:0 8px 20px rgba(0,0,0,.35)}
.card .body{padding:16px}
label{display:block;color:var(--soft);font-size:12px;margin:0 0 6px 6px}
select,textarea,input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:var(--panel);color:var(--ink);outline:none}
textarea{min-height:92px;resize:vertical}
.row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:760px){.row{grid-template-columns:1fr} .row2{grid-template-columns:1fr}}
.switch{display:flex;align-items:center;gap:8px}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.btn{padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#1f2937;color:#fff;cursor:pointer}
.btn:hover{filter:brightness(1.06)}
.btn.primary{background:linear-gradient(90deg,var(--cyan),var(--sky));color:#001018;border:0;font-weight:800}
.btn.ghost{background:transparent}
.btn.danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.45);color:#fecaca}
table{width:100%;border-collapse:separate;border-spacing:0 8px}
thead th{font-size:12px;color:var(--soft);text-align:left;padding:0 10px}
tbody td{padding:10px;background:rgba(255,255,255,.03);border-top:1px solid var(--line);border-bottom:1px solid var(--line);vertical-align:middle}
tbody tr td:first-child{border-left:1px solid var(--line);border-top-left-radius:12px;border-bottom-left-radius:12px}
tbody tr td:last-child{border-right:1px solid var(--line);border-top-right-radius:12px;border-bottom-right-radius:12px}
.right{text-align:right}
.priceCell input{width:110px}
.pill{padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.05);font-size:12px}
.stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
@media (max-width:980px){.stats{grid-template-columns:1fr}}
.stat{padding:14px;border:1px solid var(--line);border-radius:14px;background:rgba(34,211,238,.06)}
.stat h3{margin:0 0 6px 0;font-size:12px;color:#bfe1ff}
.stat .v{font-size:22px;font-weight:800}
footer{margin-top:16px;color:var(--soft);font-size:12px;text-align:center}
/* Voucher/Summary display (for preview only) */
.voucher .sheet,.summary .sheet{background:#fff;color:#111;border-radius:14px;border:1px solid #e5e7eb;overflow:hidden}
.voucher header{background:#e0f2fe;color:#082f49;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.voucher .content{padding:14px}
.voucher table{width:100%;border-collapse:collapse}
.voucher th,.voucher td{padding:8px;border-bottom:1px dashed #e5e7eb;text-align:left;color:#111}
.voucher .meta{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.voucher .meta .pill{background:#f1f5f9;border-color:#e5e7eb;color:#0f172a}
.note{color:#94a3b8;font-size:12px}
.summary header{background:#dcfce7;color:#052e1c;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.summary .content{padding:14px}
.summary table{width:100%;border-collapse:collapse}
.summary th,.summary td{padding:8px;border-bottom:1px dashed #e5e7eb;text-align:left;color:#111}
/* Print isolation for old flow (not used for auto-download now) */
@media print{
  body{background:#fff}
  .wrap{padding:0;max-width:none}
  header,.grid,.actions.global,footer{display:none}
  body[data-print="voucher"] .voucher{display:block}
  body[data-print="voucher"] .summary{display:none}
  body[data-print="summary"] .voucher{display:none}
  body[data-print="summary"] .summary{display:block}
  .voucher .sheet,.summary .sheet{box-shadow:none;border:0;border-radius:0}
}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>2D / 3D ရောင်းချက် (Reverse & Bulk) — Voucher + Summary (Auto PDF)</h1>
    <span class="badge">Auto-Save • Refresh မပျက် • Phone PDF & PNG</span>
  </header>

  <div class="grid">
    <!-- LEFT: Inputs (Cart) -->
    <section class="card">
      <div class="body">
        <div class="row2">
          <div>
            <label>အမျိုးအစား</label>
            <select id="game">
              <option value="2D">2D</option>
              <option value="3D">3D</option>
            </select>
          </div>
          <div id="twoDOptWrap">
            <label>2D Option</label>
            <select id="twoDOpt">
              <option value="TOP">အပေါ်</option>
              <option value="BOTTOM">အောက်</option>
              <option value="BOTH">အပေါ် + အောက်</option>
            </select>
          </div>
          <div id="threeDOptWrap" style="display:none">
            <label>3D Option</label>
            <select id="threeDOpt">
              <option value="STRAIGHT">3D ဒဲ့</option>
              <option value="REVERSE2">3D R</option>
              <option value="PERM6">တွတ်သုံးလုံး</option>
            </select>
          </div>
          <div class="switch">
            <input type="checkbox" id="reverseToggle">
            <label for="reverseToggle">Reverse ထည့် (2D 12↔21)</label>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>Numbers (space/comma/newline ဖြင့် အများကြီး ထည့်ပါ)</label>
          <textarea id="bulk" placeholder="ဥပမာ:\n2D — 12 34 56\n3D — 123, 456, 789"></textarea>
        </div>

        <div class="actions" style="margin-top:10px">
          <button class="btn primary" id="btnAdd">Add Numbers</button>
          <button class="btn ghost" id="btnSample">Sample ထည့်</button>
          <button class="btn danger" id="btnClearAll">Delete All (Cart only)</button>
        </div>

        <p class="pill" style="margin-top:10px">ဂဏန်းတခုစီမှာ ထိုးကြေး/ဈေးကို အောက်က ဇယားထဲမှာ တစ်ခုချင်း ပြင်နိုင်ပါတယ်</p>
      </div>
    </section>

    <!-- RIGHT: Cart Stats + PDF -->
    <aside class="card">
      <div class="body">
        <h3 style="margin-top:0">Cart အနှစ်ချုပ်</h3>
        <div class="stats">
          <div class="stat">
            <h3>ဂဏန်း (unique)</h3>
            <div class="v" id="statNums">0</div>
          </div>
          <div class="stat">
            <h3>စျေးအိုင်တမ်</h3>
            <div class="v" id="statItems">0</div>
          </div>
          <div class="stat">
            <h3>စုစုပေါင်းငွေ (MMK)</h3>
            <div class="v" id="statTotal">0</div>
          </div>
        </div>
        <div class="actions global" style="margin-top:10px;flex-wrap:wrap">
          <button class="btn" id="btnSaveVoucherPdf">ဘောင်ချာ သိမ်းမည် (PDF)</button>
          <button class="btn" id="btnSaveVoucherPng">ဘောင်ချာ Image (PNG)</button>
        </div>
        <p class="note">Voucher PDF/PNG သည် **Downloads/Gallery** ထဲသို့ အလိုအလျောက် သွားပါမည် (တက်သမျှ Browser မျိုးအလိုက် မည်သို့ထည့်မည်တခုခုပြောင်းနိုင်သည်)။</p>
      </div>
    </aside>
  </div>

  <!-- Cart Items Table -->
  <section class="card" style="margin-top:14px">
    <div class="body">
      <table>
        <thead>
          <tr>
            <th>#</th><th>Game</th><th>Number</th><th>Detail</th>
            <th class="right">Price (MMK)</th><th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- Voucher -->
  <section class="voucher" style="margin-top:14px">
    <div class="sheet" id="voucherSheet">
      <header>
        <strong>ရောင်းချေမှု ဘောင်ချာ</strong>
        <span id="vDate">-</span>
      </header>
      <div class="content">
        <div class="meta">
          <span id="vId" class="pill">Voucher: -</span>
          <span class="pill">Items: <span id="vItems">0</span></span>
          <span class="pill">Total: <span id="vTotal">0</span> MMK</span>
        </div>
        <div class="row2" style="margin-top:6px">
          <div>
            <label>Customer Name</label>
            <input id="custName" placeholder="Customer Name">
          </div>
          <div>
            <label>Note (optional)</label>
            <input id="custNote" placeholder="e.g. Paid by KBZ Pay">
          </div>
        </div>
        <table style="margin-top:10px">
          <thead>
            <tr>
              <th>#</th><th>Game</th><th>Number</th><th>Detail</th>
              <th class="right">Price (MMK)</th>
            </tr>
          </thead>
          <tbody id="vBody"></tbody>
          <tfoot>
            <tr>
              <td colspan="4" class="right" style="font-weight:700">စုစုပေါင်း (ထိုးကြေး အပြီး)</td>
              <td class="right" id="vTotalFoot" style="font-weight:700">0</td>
            </tr>
          </tfoot>
        </table>
        <p class="note" style="margin-top:8px">PDF/PNG ကိုစောင့်စရာမလိုဘဲ အလိုအလျောက် ဆွဲချပါမည်။</p>
      </div>
    </div>
  </section>

  <!-- Session Summary (day log, independent) -->
  <section class="summary" style="margin-top:14px">
    <div class="sheet" id="summarySheet">
      <header>
        <strong>နေ့လုံး စားရင်း (Session Summary)</strong>
        <span id="sDate">-</span>
      </header>
      <div class="content">
        <div class="meta" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <span class="pill">Numbers: <span id="sNums">0</span></span>
          <span class="pill">Items: <span id="sItems">0</span></span>
          <span class="pill">Total: <span id="sTotal">0</span> MMK</span>
        </div>
        <div class="actions" style="margin:8px 0;flex-wrap:wrap">
          <button class="btn" id="btnSummaryPdf">Download PDF (Summary)</button>
          <button class="btn" id="btnSummaryPng">Download Image (Summary)</button>
          <button class="btn danger" id="btnSummaryDelete">Delete Summary</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>#</th><th>Game</th><th>Number</th><th>Detail</th>
              <th class="right">Price (MMK)</th>
            </tr>
          </thead>
          <tbody id="sBody"></tbody>
        </table>
        <p class="note" style="margin-top:8px">Summary ကို **Delete Summary** ကိုနှိပ်မှပဲ ပျက်ပါမယ် — အပေါ်က Delete All နှိပ်လည်း Summary မပျက်ပါ။</p>
      </div>
    </div>
  </section>

  <footer>© 2025 • 2D/3D • Reverse • Bulk • Voucher & Summary — Auto PDF/PNG • Local Only</footer>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const fmt = (n)=>Number(n||0).toLocaleString('en-US');

/* Storage keys */
const CART_KEY='two3dCart_v6', VOUCHER_META_KEY='two3dVoucherMeta_v6', DAY_KEY='two3dDay_v6';

/* States */
const cart={rows:[]}, day={rows:[]}, meta={custName:'', custNote:''};

/* Elements */
const game=$('game'), twoDOptWrap=$('twoDOptWrap'), threeDOptWrap=$('threeDOptWrap'),
      twoDOpt=$('twoDOpt'), threeDOpt=$('threeDOpt'), reverseToggle=$('reverseToggle'),
      bulk=$('bulk'), btnAdd=$('btnAdd'), btnSample=$('btnSample'), btnClearAll=$('btnClearAll'),
      tbody=$('tbody'), statNums=$('statNums'), statItems=$('statItems'), statTotal=$('statTotal');
const vBody=$('vBody'), vTotal=$('vTotal'), vTotalFoot=$('vTotalFoot'), vItems=$('vItems'), vDate=$('vDate'), vId=$('vId'),
      custName=$('custName'), custNote=$('custNote'),
      btnSaveVoucherPdf=$('btnSaveVoucherPdf'), btnSaveVoucherPng=$('btnSaveVoucherPng');
const sBody=$('sBody'), sTotal=$('sTotal'), sItems=$('sItems'), sNums=$('sNums'), sDate=$('sDate'),
      btnSummaryPdf=$('btnSummaryPdf'), btnSummaryPng=$('btnSummaryPng'), btnSummaryDelete=$('btnSummaryDelete');

/* UI helpers */
function setModeUI(){
  const is2D = game.value==='2D';
  twoDOptWrap.style.display = is2D ? 'block' : 'none';
  threeDOptWrap.style.display = is2D ? 'none' : 'block';
  reverseToggle.disabled = !is2D;
  reverseToggle.title = is2D ? '2D Reverse toggle' : '3D Options မှာရွေးပါ';
}
game.onchange=setModeUI;

function parseNumbers(raw){
  const list = raw.split(/[^0-9]+/).filter(Boolean);
  const wanted = (game.value==='2D') ? 2 : 3;
  const cleaned = list.filter(n=>n.length===wanted).map(n=>n.slice(0,wanted));
  const seen = new Set(), out=[]; for(const n of cleaned){ if(!seen.has(n)){ seen.add(n); out.push(n);} } return out;
}
function permute3(n){ const a=n[0],b=n[1],c=n[2]; return [...new Set([a+b+c,a+c+b,b+a+c,b+c+a,c+a+b,c+b+a])]; }
function pushCart(game,number,detail,price){ cart.rows.push({game,number,detail,price:Number(price||0)}); }

function addRowsFromBulk(){
  const nums=parseNumbers(bulk.value);
  if(nums.length===0){ alert('ထည့်မည့် ဂဏန်းတွေ (digit အလိုက်) မတွေ့ပါ'); return; }
  const is2D = game.value==='2D', opt2D=twoDOpt.value, opt3D=threeDOpt.value, wantReverse=reverseToggle.checked;
  for(const n of nums){
    if(is2D){
      if(opt2D==='TOP'||opt2D==='BOTH') pushCart('2D',n,'အပေါ်',0);
      if(opt2D==='BOTTOM'||opt2D==='BOTH') pushCart('2D',n,'အောက်',0);
      if(wantReverse){
        const r=n.split('').reverse().join('');
        if(opt2D==='TOP'||opt2D==='BOTH') pushCart('2D',r,'အပေါ် (Reverse)',0);
        if(opt2D==='BOTTOM'||opt2D==='BOTH') pushCart('2D',r,'အောက် (Reverse)',0);
      }
    }else{
      if(opt3D==='STRAIGHT'){ pushCart('3D',n,'3D ဒဲ့',0); }
      else if(opt3D==='REVERSE2'){ const rev=n.split('').reverse().join(''); pushCart('3D',n,'3D R',0); if(rev!==n) pushCart('3D',rev,'3D R',0); }
      else { for(const p of permute3(n)) pushCart('3D',p,'တွတ်သုံးလုံး',0); }
    }
  }
  bulk.value=''; saveCart(); renderCart();
}

function renderCart(){
  tbody.innerHTML='';
  cart.rows.forEach((row,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${i+1}</td><td>${row.game}</td><td><strong>${row.number}</strong></td>
      <td>${row.detail}</td>
      <td class="right priceCell"><input type="number" min="0" value="${row.price}" data-i="${i}"/></td>
      <td class="right"><button class="btn danger" data-del="${i}">ဖျက်</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('input[type="number"][data-i]').forEach(inp=>{
    inp.oninput=e=>{ const i=Number(e.target.dataset.i); cart.rows[i].price=Number(e.target.value||0); saveCart(); drawCartStats(); };
  });
  tbody.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.onclick=()=>{ const i=Number(btn.dataset.del); cart.rows.splice(i,1); saveCart(); renderCart(); };
  });
  drawCartStats();
  drawVoucher();
}

function drawCartStats(){
  const total=cart.rows.reduce((a,c)=>a+Number(c.price||0),0);
  const items=cart.rows.length, numsUnique=new Set(cart.rows.map(r=>r.number)).size;
  statTotal.textContent=fmt(total); statItems.textContent=String(items); statNums.textContent=String(numsUnique);
  drawVoucher();
}

/* Voucher preview (for screen) */
function drawVoucher(){
  vBody.innerHTML='';
  cart.rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${r.game}</td><td>${r.number}</td><td>${r.detail}</td><td class="right">${fmt(r.price)}</td>`;
    vBody.appendChild(tr);
  });
  const total=cart.rows.reduce((a,c)=>a+Number(c.price||0),0);
  vTotal.textContent=fmt(total); vTotalFoot.textContent=fmt(total); vItems.textContent=String(cart.rows.length);
  const now=new Date(); vDate.textContent=now.toLocaleString();
  vId.textContent=`V-${String(now.getFullYear()).slice(-2)}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}-${String(cart.rows.length).padStart(3,'0')}`;
}

/* Summary (day log) */
function renderSummary(){
  sBody.innerHTML='';
  day.rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${r.game}</td><td>${r.number}</td><td>${r.detail}</td><td class="right">${fmt(r.price)}</td>`;
    sBody.appendChild(tr);
  });
  const total=day.rows.reduce((a,c)=>a+Number(c.price||0),0);
  const items=day.rows.length, numsUnique=new Set(day.rows.map(r=>r.number)).size;
  sTotal.textContent=fmt(total); sItems.textContent=String(items); sNums.textContent=String(numsUnique); sDate.textContent=new Date().toLocaleString();
}

/* Persist */
function saveCart(){ try{ localStorage.setItem(CART_KEY, JSON.stringify(cart.rows)); meta.custName=custName.value||''; meta.custNote=custNote.value||''; localStorage.setItem(VOUCHER_META_KEY, JSON.stringify(meta)); }catch(e){} }
function loadCart(){ try{ const raw=localStorage.getItem(CART_KEY); if(raw){ cart.rows=JSON.parse(raw)||[]; } const m=localStorage.getItem(VOUCHER_META_KEY); if(m){ const mm=JSON.parse(m)||{}; meta.custName=mm.custName||''; meta.custNote=mm.custNote||''; } }catch(e){} custName.value=meta.custName||''; custNote.value=meta.custNote||''; }
function saveDay(){ try{ localStorage.setItem(DAY_KEY, JSON.stringify(day.rows)); }catch(e){} }
function loadDay(){ try{ const raw=localStorage.getItem(DAY_KEY); if(raw){ day.rows=JSON.parse(raw)||[]; } }catch(e){} }

/* ---------- Simple PDF Generator (text-only, multi-page A4) ---------- */
function makePDF(pages){ // pages: [{lines:[{x,y,text,size}], title}]
  let pdf='%PDF-1.3\n'; const objs=[]; const add=o=>{objs.push(o); return objs.length;};
  const fontsId=add('<< /Type /Font /Subtype /Type1 /BaseFont /Helvetica >>');
  const pagesKids=[]; const pageObjs=[];
  pages.forEach((pg,pi)=>{
    const contents=`BT\n/F1 12 Tf\n`+pg.lines.map(l=>`/${l.font||'F1'} ${l.size||10} Tf\n${l.x} ${l.y} Td\n(${escapePDF(l.text)}) Tj\n`).join('')+`ET`;
    const stream=`<< /Length ${contents.length} >>\nstream\n${contents}\nendstream`;
    const contentsId=add(stream);
    const pageId=add(`<< /Type /Page /Parent 0 0 R /MediaBox [0 0 595 842] /Resources << /Font << /F1 ${fontsId} 0 R >> >> /Contents ${contentsId} 0 R >>`);
    pageObjs.push(pageId); pagesKids.push(`${pageId} 0 R`);
  });
  const pagesId=add(`<< /Type /Pages /Kids [ ${pagesKids.join(' ')} ] /Count ${pagesKids.length} >>`);
  // fix parent refs in pages
  for(let i=0;i<pageObjs.length;i++){
    objs[pageObjs[i]-1]=objs[pageObjs[i]-1].replace('/Parent 0 0 R',`/Parent ${pagesId} 0 R`);
  }
  const catalogId=add(`<< /Type /Catalog /Pages ${pagesId} 0 R >>`);
  /* xref */
  let xref='xref\n0 '+(objs.length+1)+'\n0000000000 65535 f \n';
  let pos=pdf.length; const offsets=[];
  objs.forEach((o,i)=>{ offsets[i]=pos; pdf+=`${i+1} 0 obj\n${o}\nendobj\n`; pos=pdf.length; });
  offsets.forEach(off=>{ xref+=padoff(off)+' 00000 n \n'; });
  const trailer=`trailer\n<< /Size ${objs.length+1} /Root ${catalogId} 0 R >>\nstartxref\n${pos}\n%%EOF`;
  return pdf+xref+trailer;
  function padoff(n){ let s=String(n); while(s.length<10)s='0'+s; return s; }
  function escapePDF(s){ return (s||'').replace(/\\/g,'\\\\').replace(/\(/g,'\\(').replace(/\)/g,'\\)').replace(/\r?\n/g,' '); }
}
function buildVoucherPDFData(){
  const margin=40, lh=16, startY=800; let y=startY; const lines=[];
  const now=new Date().toLocaleString();
  lines.push({x:margin,y, text:'ရောင်းချေမှု ဘောင်ချာ', size:16}); y-=lh;
  lines.push({x:margin,y, text:`Date: ${now}`}); y-=lh;
  lines.push({x:margin,y, text:`Voucher: ${$('vId').textContent}`}); y-=lh;
  lines.push({x:margin,y, text:`Customer: ${(custName.value||'-')}   Note: ${(custNote.value||'-')}`}); y-=lh*2;

  lines.push({x:margin,y, text:'#'}); lines.push({x:margin+30,y, text:'Game'});
  lines.push({x:margin+90,y, text:'Number'}); lines.push({x:margin+160,y, text:'Detail'});
  lines.push({x:margin+300,y, text:'Price (MMK)'}); y-=lh;

  cart.rows.forEach((r,i)=>{
    if(y<60){ pages.push({lines:[...linesOnPage]}); linesOnPage.length=0; y=startY; } // (not used here; simplified single page)
  });

  cart.rows.forEach((r,i)=>{
    lines.push({x:margin,y, text:String(i+1)});
    lines.push({x:margin+30,y, text:r.game});
    lines.push({x:margin+90,y, text:r.number});
    lines.push({x:margin+160,y, text:r.detail});
    lines.push({x:margin+300,y, text:fmt(r.price)});
    y-=lh;
  });
  y-=lh;
  const total=cart.rows.reduce((a,c)=>a+Number(c.price||0),0);
  lines.push({x:margin+220,y, text:'စုစုပေါင်း (ထိုးကြေး အပြီး):'}); lines.push({x:margin+300,y, text:fmt(total)});
  return paginateLines(lines);
}
function buildSummaryPDFData(){
  const margin=40, lh=16, startY=800; let y=startY; const lines=[];
  lines.push({x:margin,y, text:'နေ့လုံး စားရင်း (Session Summary)', size:16}); y-=lh;
  lines.push({x:margin,y, text:`Date: ${new Date().toLocaleString()}`}); y-=lh;
  const total=day.rows.reduce((a,c)=>a+Number(c.price||0),0);
  lines.push({x:margin,y, text:`Numbers: ${new Set(day.rows.map(r=>r.number)).size}   Items: ${day.rows.length}   Total: ${fmt(total)} MMK`}); y-=lh*2;

  lines.push({x:margin,y, text:'#'}); lines.push({x:margin+30,y, text:'Game'});
  lines.push({x:margin+90,y, text:'Number'}); lines.push({x:margin+160,y, text:'Detail'});
  lines.push({x:margin+300,y, text:'Price (MMK)'}); y-=lh;

  day.rows.forEach((r,i)=>{
    lines.push({x:margin,y, text:String(i+1)});
    lines.push({x:margin+30,y, text:r.game});
    lines.push({x:margin+90,y, text:r.number});
    lines.push({x:margin+160,y, text:r.detail});
    lines.push({x:margin+300,y, text:fmt(r.price)});
    y-=lh;
  });
  return paginateLines(lines);
}
function paginateLines(lines){
  const pages=[]; let cur=[]; let y=800; const lh=16, top=800, bottom=60;
  for(const l of lines){
    if(l.y!==undefined){ /* absolute prepared */ }
  }
  // Re-layout: simple sequential layout
  cur=[]; let yy=800;
  const rebuild=[];
  for(const l of lines){
    if(l.text==='__SECTION__'){ if(cur.length){ pages.push({lines:cur}); cur=[]; yy=800; continue; } }
    if(yy<bottom){ pages.push({lines:cur}); cur=[]; yy=800; }
    cur.push({x:l.x||40, y:yy, text:l.text, size:l.size||10});
    yy -= (l.size?18:16);
  }
  if(cur.length) pages.push({lines:cur});
  return pages;
}
/* ---------- PNG Export (without external libs) ---------- */
async function nodeToPNG(node, name){
  const w=node.scrollWidth, h=node.scrollHeight;
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">
    <foreignObject width="100%" height="100%">${new XMLSerializer().serializeToString(node)}</foreignObject>
  </svg>`;
  const blob = new Blob([svg], {type:'image/svg+xml;charset=utf-8'});
  const url = URL.createObjectURL(blob);
  const img = new Image(); img.crossOrigin='anonymous';
  const png = await new Promise(res=>{
    img.onload=()=>{
      const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
      const ctx=canvas.getContext('2d'); ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,w,h);
      ctx.drawImage(img,0,0); canvas.toBlob(b=>res(b),'image/png');
      URL.revokeObjectURL(url);
    };
    img.src=url;
  });
  downloadBlob(name, png);
}

/* Download helpers */
function downloadBlob(filename, blob){
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename;
  document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 200);
}
function downloadPDF(filename, pages){
  const pdfText = makePDF(pages);
  const blob = new Blob([pdfText], {type:'application/pdf'});
  downloadBlob(filename, blob);
}

/* Actions */
btnAdd.onclick=addRowsFromBulk;
btnClearAll.onclick=()=>{ if(confirm('Cart (ဘောင်ချာ) အားလုံးဖျက်မလား? Summary မထိပါ။')){ cart.rows.splice(0,cart.rows.length); localStorage.removeItem(CART_KEY); renderCart(); } };
btnSample.onclick=()=>{ if(game.value==='2D'){ bulk.value="12 34 56, 78 90"; twoDOpt.value='BOTH'; reverseToggle.checked=true; } else { bulk.value="123 456, 789"; threeDOpt.value='PERM6'; } };
custName.oninput=saveCart; custNote.oninput=saveCart;

/* Save Voucher = append to Summary + auto-download PDF / optional PNG */
btnSaveVoucherPdf.onclick=()=>{
  if(cart.rows.length===0){ alert('Cart အချည်းနှီးပါ'); return; }
  const ts=Date.now(), name=(custName.value||'').trim(), note=(custNote.value||'').trim();
  cart.rows.forEach(r=>{ day.rows.push({...r, ts, custName:name, note}); });
  saveDay(); renderSummary();
  const pages = buildVoucherPDFData();
  downloadPDF(`voucher-${new Date().toISOString().slice(0,10)}.pdf`, pages);
};
btnSaveVoucherPng.onclick=()=>{ nodeToPNG($('voucherSheet'), `voucher-${new Date().toISOString().slice(0,10)}.png`); };

/* Summary controls */
btnSummaryPdf.onclick=()=>{
  if(day.rows.length===0){ alert('Summary မရှိသေးပါ'); return; }
  const pages = buildSummaryPDFData();
  downloadPDF(`summary-${new Date().toISOString().slice(0,10)}.pdf`, pages);
};
btnSummaryPng.onclick=()=>{ nodeToPNG($('summarySheet'), `summary-${new Date().toISOString().slice(0,10)}.png`); };
btnSummaryDelete.onclick=()=>{ if(confirm('နေ့လုံး စားရင်းကို ဖျက်မလား? (Cart မထိ)')){ day.rows.splice(0,day.rows.length); saveDay(); renderSummary(); } };

/* Shortcuts */
bulk.addEventListener('keydown', (e)=>{ if((e.metaKey||e.ctrlKey)&&e.key==='Enter'){ e.preventDefault(); addRowsFromBulk(); } });

/* Init */
function init(){ loadCart(); loadDay(); setModeUI(); renderCart(); renderSummary(); }
init();
</script>
</body>
</html>
